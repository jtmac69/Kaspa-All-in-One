# Docker Compose for Kaspa All-in-One

services:
  # ============================================================================
  # CORE INFRASTRUCTURE (Always Available)
  # ============================================================================
  
  # Kaspa Node - Official Docker image (Core component)
  kaspa-node:
    image: kaspanet/rusty-kaspad:latest
    container_name: kaspa-node
    restart: unless-stopped
    ports:
      - "${KASPA_NODE_P2P_PORT:-16110}:16110"  # P2P port (public)
      - "${KASPA_NODE_RPC_PORT:-16111}:16111"  # RPC port (local access)
    volumes:
      - kaspa-data:/app/data
      - ./logs/kaspa-node:/app/logs
    environment:
      - PUBLIC_NODE=${PUBLIC_NODE:-true}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - KASPAD_UTXOINDEX=true
      - KASPAD_RPCBIND=0.0.0.0:16111
      - KASPAD_RPCLISTEN_BORSH=0.0.0.0:17110
      - KASPAD_RPCLISTEN_JSON=0.0.0.0:18110
    command: "kaspad --utxoindex --rpclisten=0.0.0.0:16111 --listen=0.0.0.0:16110"
    networks:
      - kaspa-network
    # Healthcheck disabled - curl not available in kaspa node image
    # Container stability is monitored via external health checks
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:16111", "-X", "POST", "-H", "Content-Type: application/json", "-d", '{"method":"ping","params":{}}']
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 60s

  # Management Dashboard - NOW HOST-BASED (not containerized)
  # The dashboard runs directly on the host system for better Docker monitoring
  # Start with: cd services/dashboard && npm start
  # Or use systemd: sudo systemctl start kaspa-dashboard
  # See .kiro/specs/management-dashboard/design.md for details

  # Installation Wizard (DEPRECATED - Runs on host, not in container)
  # NOTE: The wizard should be started using ./services/wizard/backend/start-local.sh
  # This container definition is kept for backwards compatibility but is not recommended
  wizard:
    build:
      context: ./services/wizard
      dockerfile: Dockerfile
    container_name: kaspa-wizard
    restart: "no"  # Only runs on-demand, not automatically
    ports:
      - "${WIZARD_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - WIZARD_MODE=${WIZARD_MODE:-install}  # install or reconfigure
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PROJECT_ROOT=/workspace
      - WIZARD_AUTO_START=${WIZARD_AUTO_START:-false}
      - WIZARD_SECURITY_TOKEN=${WIZARD_SECURITY_TOKEN:-}
      - WIZARD_SESSION_SECRET=${WIZARD_SESSION_SECRET:-}
      - WIZARD_MAX_RETRIES=${WIZARD_MAX_RETRIES:-3}
      - WIZARD_TIMEOUT=${WIZARD_TIMEOUT:-300}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/workspace
      - ./.env:/workspace/.env
      - ./docker-compose.yml:/workspace/docker-compose.yml:ro
      - wizard-state:/app/state
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - kaspa-network
    profiles:
      - wizard
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Reverse Proxy (Only needed for user-facing applications)
  nginx:
    image: nginx:alpine
    container_name: kaspa-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/ssl:/etc/nginx/ssl:ro
    depends_on:
      kaspa-node:
        condition: service_started
    networks:
      - kaspa-network
    profiles:
      - kaspa-user-applications

  # ============================================================================
  # KASPA-USER-APPLICATIONS PROFILE - User-facing applications
  # ============================================================================

  # Kasia Messaging App
  kasia-app:
    build:
      context: ./services/kasia
      dockerfile: Dockerfile
      args:
        KASIA_VERSION: ${KASIA_VERSION:-master}
        # Pass indexer URLs as build arguments for Vite build
        VITE_INDEXER_MAINNET_URL: ${REMOTE_KASIA_INDEXER_URL:-https://indexer.kasia.fyi/}
        VITE_INDEXER_TESTNET_URL: ${REMOTE_KASIA_INDEXER_URL:-https://dev-indexer.kasia.fyi/}
        VITE_DEFAULT_MAINNET_KASPA_NODE_URL: ${REMOTE_KASPA_NODE_WBORSH_URL:-wss://wrpc.kasia.fyi}
        VITE_DEFAULT_TESTNET_KASPA_NODE_URL: ${REMOTE_KASPA_NODE_WBORSH_URL:-wss://wrpc.kasia.fyi}
        VITE_DEFAULT_KASPA_NETWORK: ${KASPA_NETWORK:-mainnet}
        VITE_DISABLE_INDEXER: "false"
    container_name: kasia-app
    restart: unless-stopped
    ports:
      - "${KASIA_APP_PORT:-3001}:3000"
    environment:
      # Runtime environment variables for the startup script
      - VITE_DEFAULT_KASPA_NETWORK=${KASPA_NETWORK:-mainnet}
      - VITE_ALLOWED_KASPA_NETWORKS=${KASPA_NETWORK:-mainnet}
      - VITE_DISABLE_PASSWORD_REQUIREMENTS=${KASIA_DISABLE_PASSWORD_REQUIREMENTS:-false}
      - VITE_LOG_LEVEL=${KASIA_LOG_LEVEL:-info}
      - VITE_DEV_MODE=false
      - VITE_INDEXER_MAINNET_URL=${REMOTE_KASIA_INDEXER_URL:-https://indexer.kasia.fyi/}
      - VITE_INDEXER_TESTNET_URL=${REMOTE_KASIA_INDEXER_URL:-https://dev-indexer.kasia.fyi/}
      - VITE_DISABLE_INDEXER=false
      - VITE_DEFAULT_MAINNET_KASPA_NODE_URL=${REMOTE_KASPA_NODE_WBORSH_URL:-wss://wrpc.kasia.fyi}
      - VITE_DEFAULT_TESTNET_KASPA_NODE_URL=${REMOTE_KASPA_NODE_WBORSH_URL:-wss://wrpc.kasia.fyi}
    depends_on:
      kaspa-node:
        condition: service_started
    networks:
      - kaspa-network
    profiles:
      - kaspa-user-applications
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # K Social App
  k-social:
    build:
      context: ./services/k-social
      dockerfile: Dockerfile
    container_name: k-social
    restart: unless-stopped
    ports:
      - "${KSOCIAL_APP_PORT:-3003}:3000"
    environment:
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-http://kaspa-node:16111}
      - KSOCIAL_INDEXER_URL=${REMOTE_KSOCIAL_INDEXER_URL:-https://indexer.kaspatalk.net/}
    depends_on:
      kaspa-node:
        condition: service_started
    networks:
      - kaspa-network
    profiles:
      - kaspa-user-applications
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # INDEXER-SERVICES PROFILE - Local indexing and data services
  # ============================================================================

  # Shared TimescaleDB for Indexers (Enhanced for 10bps Kaspa rate)
  indexer-db:
    image: timescale/timescaledb:latest-pg16
    container_name: indexer-db
    restart: unless-stopped
    shm_size: 4G  # Increased shared memory for TimescaleDB
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-kaspa_indexers}
      - POSTGRES_USER=${POSTGRES_USER:-indexer}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_password}
      - TIMESCALEDB_TELEMETRY=${TIMESCALEDB_TELEMETRY:-off}
      - PGPORT=${POSTGRES_PORT:-5432}
    # TimescaleDB optimizations for Kaspa's 10bps rate
    command: >
      -c shared_preload_libraries=timescaledb,pg_stat_statements
      -c pg_stat_statements.max=10000
      -c pg_stat_statements.track=all
      -c timescaledb.max_background_workers=8
      -c max_worker_processes=16
      -c work_mem=256MB
      -c shared_buffers=2GB
      -c effective_cache_size=6GB
      -c maintenance_work_mem=512MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
    volumes:
      - indexer-db-data:/var/lib/postgresql/data
      - ./config/postgres/init:/docker-entrypoint-initdb.d
    networks:
      - kaspa-network
    profiles:
      - indexer-services
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-indexer} -d ${POSTGRES_DB:-kaspa_indexers}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Kasia Indexer
  kasia-indexer:
    image: kkluster/kasia-indexer:main
    platform: linux/amd64
    container_name: kasia-indexer
    restart: unless-stopped
    stdin_open: true
    tty: true
    ports:
      - "${KASIA_INDEXER_PORT:-3002}:8080"
    environment:
      - KASPA_NODE_WBORSH_URL=${KASPA_NODE_WBORSH_URL:-ws://kaspa-node:17110}
      - RUST_LOG=${KASIA_RUST_LOG:-info}
      - KASIA_INDEXER_DB_ROOT=/app/data
      - NETWORK_TYPE=${NETWORK_TYPE:-mainnet}
      - RUST_BACKTRACE=1
    volumes:
      - kasia-indexer-data:/app/data
    networks:
      - kaspa-network
    profiles:
      - indexer-services
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # K Social Indexer
  k-indexer:
    build:
      context: ./services/k-indexer
      dockerfile: Dockerfile
    container_name: k-indexer
    restart: unless-stopped
    ports:
      - "${KSOCIAL_INDEXER_PORT:-3004}:8080"
    environment:
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-http://kaspa-node:16111}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-indexer}:${POSTGRES_PASSWORD:-secure_password}@indexer-db:5432/ksocial
    depends_on:
      indexer-db:
        condition: service_healthy
    networks:
      - kaspa-network
    profiles:
      - indexer-services
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Simply Kaspa Indexer
  simply-kaspa-indexer:
    build:
      context: ./services/simply-kaspa-indexer
      dockerfile: Dockerfile
      args:
        SIMPLY_KASPA_VERSION: ${SIMPLY_KASPA_VERSION:-master}
        ENABLE_TIMESCALEDB: "true"
    container_name: simply-kaspa-indexer
    restart: unless-stopped
    ports:
      - "${SIMPLY_INDEXER_PORT:-3005}:3000"
    environment:
      # Kaspa node connection
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-http://kaspa-node:16111}
      # Database connection
      - DATABASE_URL=postgresql://${POSTGRES_USER:-indexer}:${POSTGRES_PASSWORD:-secure_password}@indexer-db:5432/simply_kaspa
      # Indexing mode
      - INDEXER_MODE=${SIMPLY_INDEXER_MODE:-full}  # full, light, archive, personal
      # TimescaleDB optimizations
      - ENABLE_TIMESCALEDB=true
      - ENABLE_COMPRESSION=true
      - COMPRESSION_AGE_HOURS=${SIMPLY_COMPRESSION_AGE_HOURS:-2}
      - BATCH_SIZE=${SIMPLY_BATCH_SIZE:-1000}
      - CHUNK_INTERVAL_MINUTES=${SIMPLY_CHUNK_INTERVAL:-30}
      # Retention policies (Personal Indexer)
      - RETENTION_DAYS=${SIMPLY_RETENTION_DAYS:-0}  # 0 = keep forever
      # Performance tuning
      - LOG_LEVEL=${SIMPLY_LOG_LEVEL:-info}
      - CACHE_SIZE=${SIMPLY_CACHE_SIZE:-1000}
    volumes:
      - simply-kaspa-data:/app/data
      - simply-kaspa-logs:/app/logs
    depends_on:
      indexer-db:
        condition: service_healthy
      kaspa-node:
        condition: service_started
    networks:
      - kaspa-network
    profiles:
      - indexer-services
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # MINING PROFILE - Mining stratum server
  # ============================================================================

  # Kaspa Mining Stratum
  kaspa-stratum:
    build:
      context: ./services/kaspa-stratum
      dockerfile: Dockerfile
      args:
        STRATUM_VERSION: ${STRATUM_VERSION:-master}
    container_name: kaspa-stratum
    restart: unless-stopped
    ports:
      - "${STRATUM_PORT:-5555}:5555"  # Stratum port
    environment:
      - KASPA_RPC_SERVER=${REMOTE_KASPA_NODE_URL:-kaspa-node:16111}
      - STRATUM_PORT=5555
      - LOG_LEVEL=${STRATUM_LOG_LEVEL:-info}
      - MIN_SHARE_DIFF=${STRATUM_MIN_SHARE_DIFF:-4}
      - EXTRA_NONCE_SIZE=${STRATUM_EXTRA_NONCE_SIZE:-0}
    depends_on:
      kaspa-node:
        condition: service_started
    networks:
      - kaspa-network
    profiles:
      - mining
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "5555"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================================================
  # ARCHIVE-NODE PROFILE - Extended data retention and historical analysis
  # ============================================================================

  # Archive TimescaleDB (separate for long-term storage with maximum compression)
  archive-db:
    image: timescale/timescaledb:latest-pg16
    container_name: archive-db
    restart: unless-stopped
    shm_size: 8G  # Larger shared memory for archive operations
    ports:
      - "${ARCHIVE_POSTGRES_PORT:-5433}:5432"
    environment:
      - POSTGRES_DB=${ARCHIVE_POSTGRES_DB:-kaspa_archive}
      - POSTGRES_USER=${ARCHIVE_POSTGRES_USER:-archiver}
      - POSTGRES_PASSWORD=${ARCHIVE_POSTGRES_PASSWORD:-archive_password}
      - TIMESCALEDB_TELEMETRY=${TIMESCALEDB_TELEMETRY:-off}
      - PGPORT=${ARCHIVE_POSTGRES_PORT:-5433}
    # Archive-optimized TimescaleDB configuration
    command: >
      -c shared_preload_libraries=timescaledb,pg_stat_statements
      -c pg_stat_statements.max=10000
      -c pg_stat_statements.track=all
      -c timescaledb.max_background_workers=16
      -c max_worker_processes=32
      -c work_mem=512MB
      -c shared_buffers=4GB
      -c effective_cache_size=12GB
      -c maintenance_work_mem=1GB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=32MB
      -c default_statistics_target=100
      -c timescaledb.compress_segmentby_default=true
      -c timescaledb.compress_orderby_default=true
    volumes:
      - archive-db-data:/var/lib/postgresql/data
      - ./config/postgres/archive-init:/docker-entrypoint-initdb.d
    networks:
      - kaspa-network
    profiles:
      - archive-node
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${ARCHIVE_POSTGRES_USER:-archiver} -d ${ARCHIVE_POSTGRES_DB:-kaspa_archive}"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Archive Indexer (for historical data)
  archive-indexer:
    build:
      context: ./services/simply-kaspa-indexer
      dockerfile: Dockerfile
    container_name: archive-indexer
    restart: unless-stopped
    ports:
      - "${ARCHIVE_INDEXER_PORT:-3006}:3000"
    environment:
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-http://kaspa-node:16111}
      - DATABASE_URL=postgresql://${ARCHIVE_POSTGRES_USER:-archiver}:${ARCHIVE_POSTGRES_PASSWORD:-archive_password}@archive-db:5432/kaspa_archive
      - INDEXER_MODE=archive
      - RETENTION_DAYS=${ARCHIVE_RETENTION_DAYS:-0}  # 0 = keep forever
    depends_on:
      archive-db:
        condition: service_healthy
    networks:
      - kaspa-network
    profiles:
      - archive-node
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # DEVELOPMENT PROFILE - Development and debugging tools
  # ============================================================================

  # Portainer for container management
  portainer:
    image: portainer/portainer-ce:latest
    container_name: kaspa-portainer
    restart: unless-stopped
    ports:
      - "${PORTAINER_PORT:-9000}:9000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - kaspa-network
    profiles:
      - development

  # pgAdmin for database management
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: kaspa-pgadmin
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-9001}:80"
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_EMAIL:-admin@kaspa-aio.local}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin}
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    networks:
      - kaspa-network
    profiles:
      - development

volumes:
  kaspa-data:
  kasia-indexer-data:
  simply-kaspa-data:
  simply-kaspa-logs:
  indexer-db-data:
  archive-db-data:
  portainer-data:
  pgadmin-data:
  wizard-state:

networks:
  kaspa-network:
    driver: bridge