# Docker Compose for Kaspa All-in-One
# Generated by Installation Wizard
# Date: 2025-12-12T13:53:44.352Z

services:
  # ============================================================================
  # CORE INFRASTRUCTURE
  # ============================================================================
  
  # Installation Wizard (DEPRECATED - Runs on host, not in container)
  # NOTE: The wizard should be started using ./services/wizard/backend/start-local.sh
  wizard:
    build:
      context: ./services/wizard
      dockerfile: Dockerfile
    container_name: kaspa-wizard
    restart: "no"
    ports:
      - "${WIZARD_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - WIZARD_MODE=${WIZARD_MODE:-install}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PROJECT_ROOT=/workspace
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/workspace
      - ./.env:/workspace/.env
      - ./docker-compose.yml:/workspace/docker-compose.yml:ro
      - wizard-state:/app/state
    networks:
      - kaspa-network
    profiles:
      - wizard

  # ============================================================================
  # INDEXER-SERVICES PROFILE - Local indexing and data services
  # ============================================================================

  # Shared TimescaleDB for Indexers
  indexer-db:
    image: timescale/timescaledb:latest-pg16
    container_name: indexer-db
    restart: unless-stopped
    shm_size: 4G
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-kaspa_indexers}
      - POSTGRES_USER=${POSTGRES_USER:-indexer}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_password}
    volumes:
      - indexer-db-data:/data/timescaledb
      - ./config/postgres/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-indexer} -d ${POSTGRES_DB:-kaspa_indexers}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kaspa-network
    profiles:
      - indexer-services

  # Kasia Indexer
  kasia-indexer:
    image: kkluster/kasia-indexer:main
    platform: linux/amd64
    container_name: kasia-indexer
    restart: unless-stopped
    ports:
      - "${KASIA_INDEXER_PORT:-3002}:8080"
    environment:
      - KASPA_NODE_WBORSH_URL=${KASPA_NODE_WBORSH_URL:-wss://wrpc.kasia.fyi}
      - NETWORK_TYPE=${KASPA_NETWORK:-mainnet}
    volumes:
      - kasia-indexer-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8080/metrics"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - kaspa-network
    profiles:
      - indexer-services

  # K-Indexer (K-Social Indexer)
  k-indexer:
    build:
      context: ./services/k-indexer
      dockerfile: Dockerfile
    container_name: k-indexer
    restart: unless-stopped
    ports:
      - "${K_INDEXER_PORT:-3006}:8080"
    environment:
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-https://api.kaspa.org}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-indexer}:${POSTGRES_PASSWORD}@indexer-db:${POSTGRES_PORT:-5432}/ksocial
      - POSTGRES_HOST=indexer-db
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=ksocial
      - POSTGRES_USER=${POSTGRES_USER:-indexer}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - k-indexer-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    depends_on:
      indexer-db:
        condition: service_healthy
    networks:
      - kaspa-network
    profiles:
      - indexer-services

  # Simply Kaspa Indexer
  simply-kaspa-indexer:
    build:
      context: ./services/simply-kaspa-indexer
      dockerfile: Dockerfile
    container_name: simply-kaspa-indexer
    restart: unless-stopped
    ports:
      - "${SIMPLY_INDEXER_PORT:-3005}:3000"
    environment:
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-https://api.kaspa.org}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-indexer}:${POSTGRES_PASSWORD}@indexer-db:5432/simply_kaspa
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/metrics"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    depends_on:
      indexer-db:
        condition: service_healthy
    networks:
      - kaspa-network
    profiles:
      - indexer-services

volumes:
  kaspa-data:
  wizard-state:
  kasia-indexer-data:
  k-indexer-data:
  indexer-db-data:

networks:
  kaspa-network:
    driver: bridge
