# Docker Compose for Kaspa All-in-One
# Generated by Installation Wizard
# Date: 2025-12-12T13:53:44.352Z

services:
  # ============================================================================
  # CORE INFRASTRUCTURE
  # ============================================================================
  
  # Installation Wizard (DEPRECATED - Runs on host, not in container)
  # NOTE: The wizard should be started using ./services/wizard/backend/start-local.sh
  wizard:
    build:
      context: ./services/wizard
      dockerfile: Dockerfile
    container_name: kaspa-wizard
    restart: "no"
    ports:
      - "${WIZARD_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - WIZARD_MODE=${WIZARD_MODE:-install}
      - DOCKER_HOST=unix:///var/run/docker.sock
      - PROJECT_ROOT=/workspace
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - .:/workspace
      - ./.env:/workspace/.env
      - ./docker-compose.yml:/workspace/docker-compose.yml:ro
      - wizard-state:/app/state
    networks:
      - kaspa-network
    profiles:
      - wizard

  # ============================================================================
  # INDEXER-SERVICES PROFILE - Local indexing and data services
  # ============================================================================

  # K-Social Database (dedicated for k-indexer)
  k-social-db:
    image: timescale/timescaledb:latest-pg16
    container_name: k-social-db
    restart: unless-stopped
    shm_size: 2G
    ports:
      - "${K_SOCIAL_DB_PORT:-5433}:5432"
    environment:
      - POSTGRES_DB=ksocial
      - POSTGRES_USER=k_social_user
      - POSTGRES_PASSWORD=${K_SOCIAL_DB_PASSWORD:-k_social_secure_pass}
    volumes:
      - k-social-db-data:/var/lib/postgresql/data
      - ./config/postgres/k-social-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U k_social_user -d ksocial"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kaspa-network
    profiles:
      - indexer-services

  # Simply Kaspa Database (dedicated for simply-kaspa-indexer)
  simply-kaspa-db:
    image: timescale/timescaledb:latest-pg16
    container_name: simply-kaspa-db
    restart: unless-stopped
    shm_size: 2G
    ports:
      - "${SIMPLY_KASPA_DB_PORT:-5434}:5432"
    environment:
      - POSTGRES_DB=simply_kaspa
      - POSTGRES_USER=simply_kaspa_user
      - POSTGRES_PASSWORD=${SIMPLY_KASPA_DB_PASSWORD:-simply_kaspa_secure_pass}
    volumes:
      - simply-kaspa-db-data:/var/lib/postgresql/data
      - ./config/postgres/simply-kaspa-init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U simply_kaspa_user -d simply_kaspa"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - kaspa-network
    profiles:
      - indexer-services

  # Kasia Indexer
  kasia-indexer:
    image: kkluster/kasia-indexer:main
    platform: linux/amd64
    container_name: kasia-indexer
    restart: unless-stopped
    ports:
      - "${KASIA_INDEXER_PORT:-3002}:8080"
    environment:
      - KASPA_NODE_WBORSH_URL=${KASPA_NODE_WBORSH_URL:-wss://rose.kaspa.green/kaspa/mainnet/wrpc/borsh}
      - NETWORK_TYPE=${KASPA_NETWORK:-mainnet}
    volumes:
      - kasia-indexer-data:/app/data
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8080/metrics"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - kaspa-network
    profiles:
      - indexer-services

  # K-Indexer (K-Social Indexer)
  k-indexer:
    build:
      context: ./services/k-indexer
      dockerfile: Dockerfile
    container_name: k-indexer
    restart: unless-stopped
    ports:
      - "${K_INDEXER_PORT:-3006}:8080"
    environment:
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-https://api.kaspa.org}
      - DATABASE_URL=postgresql://k_social_user:${K_SOCIAL_DB_PASSWORD:-k_social_secure_pass}@k-social-db:5432/ksocial
      - POSTGRES_HOST=k-social-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=ksocial
      - POSTGRES_USER=k_social_user
      - POSTGRES_PASSWORD=${K_SOCIAL_DB_PASSWORD:-k_social_secure_pass}
    volumes:
      - k-indexer-data:/app/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    depends_on:
      k-social-db:
        condition: service_healthy
    networks:
      - kaspa-network
    profiles:
      - indexer-services

  # Simply Kaspa Indexer
  simply-kaspa-indexer:
    build:
      context: ./services/simply-kaspa-indexer
      dockerfile: Dockerfile
    container_name: simply-kaspa-indexer
    restart: unless-stopped
    ports:
      - "${SIMPLY_INDEXER_PORT:-3005}:3000"
    environment:
      - KASPA_NODE_URL=${REMOTE_KASPA_NODE_URL:-https://api.kaspa.org}
      - DATABASE_URL=postgresql://simply_kaspa_user:${SIMPLY_KASPA_DB_PASSWORD:-simply_kaspa_secure_pass}@simply-kaspa-db:5432/simply_kaspa
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:3000/api/metrics"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    depends_on:
      simply-kaspa-db:
        condition: service_healthy
    networks:
      - kaspa-network
    profiles:
      - indexer-services

volumes:
  kaspa-data:
  wizard-state:
  kasia-indexer-data:
  k-indexer-data:
  k-social-db-data:
  simply-kaspa-db-data:

networks:
  kaspa-network:
    driver: bridge
