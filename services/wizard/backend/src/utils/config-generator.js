const crypto = require('crypto');
const fs = require('fs').promises;
const path = require('path');
const Joi = require('joi');

class ConfigGenerator {
  constructor() {
    this.configSchema = Joi.object({
      // Core settings
      PUBLIC_NODE: Joi.boolean().default(false),
      EXTERNAL_IP: Joi.string().ip().allow('').optional(),
      
      // Network settings
      KASPA_P2P_PORT: Joi.number().integer().min(1024).max(65535).default(16110),
      KASPA_RPC_PORT: Joi.number().integer().min(1024).max(65535).default(16111),
      DASHBOARD_PORT: Joi.number().integer().min(1024).max(65535).default(3001),
      NGINX_HTTP_PORT: Joi.number().integer().min(1024).max(65535).default(80),
      NGINX_HTTPS_PORT: Joi.number().integer().min(1024).max(65535).default(443),
      
      // Database settings
      POSTGRES_USER: Joi.string().alphanum().min(3).max(30).default('kaspa'),
      POSTGRES_PASSWORD: Joi.string().min(16).required(),
      POSTGRES_DB: Joi.string().alphanum().min(3).max(30).default('kaspa_explorer'),
      POSTGRES_PORT: Joi.number().integer().min(1024).max(65535).default(5432),
      
      // Archive database settings
      ARCHIVE_POSTGRES_USER: Joi.string().alphanum().min(3).max(30).default('kaspa_archive'),
      ARCHIVE_POSTGRES_PASSWORD: Joi.string().min(16).optional(),
      ARCHIVE_POSTGRES_DB: Joi.string().alphanum().min(3).max(30).default('kaspa_archive'),
      ARCHIVE_POSTGRES_PORT: Joi.number().integer().min(1024).max(65535).default(5433),
      
      // Monitoring settings
      ENABLE_MONITORING: Joi.boolean().default(true),
      LOG_LEVEL: Joi.string().valid('error', 'warn', 'info', 'debug').default('info'),
      
      // SSL settings
      ENABLE_SSL: Joi.boolean().default(false),
      SSL_DOMAIN: Joi.string().hostname().allow('').optional(),
      SSL_EMAIL: Joi.string().email().allow('').optional(),
      
      // Indexer settings
      INDEXER_MODE: Joi.string().valid('full', 'light', 'archive', 'personal').default('full'),
      
      // Mining settings
      MINING_ADDRESS: Joi.string().allow('').optional(),
      STRATUM_PORT: Joi.number().integer().min(1024).max(65535).default(5555)
    });
  }

  generateSecurePassword(length = 32) {
    return crypto.randomBytes(length).toString('base64').slice(0, length);
  }

  async validateConfig(config) {
    try {
      const validated = await this.configSchema.validateAsync(config, {
        abortEarly: false,
        stripUnknown: true
      });
      return { valid: true, config: validated, errors: [] };
    } catch (error) {
      return {
        valid: false,
        config: null,
        errors: error.details.map(d => ({
          field: d.path.join('.'),
          message: d.message
        }))
      };
    }
  }

  async generateEnvFile(config, profiles) {
    const lines = [
      '# Kaspa All-in-One Configuration',
      '# Generated by Installation Wizard',
      `# Date: ${new Date().toISOString()}`,
      '',
      '# Active Profiles',
      `COMPOSE_PROFILES=${profiles.join(',')}`,
      '',
      '# Core Settings',
      `PUBLIC_NODE=${config.PUBLIC_NODE || 'false'}`,
    ];

    if (config.EXTERNAL_IP) {
      lines.push(`EXTERNAL_IP=${config.EXTERNAL_IP}`);
    }

    lines.push(
      '',
      '# Network Ports',
      `KASPA_P2P_PORT=${config.KASPA_P2P_PORT || 16110}`,
      `KASPA_RPC_PORT=${config.KASPA_RPC_PORT || 16111}`,
      `DASHBOARD_PORT=${config.DASHBOARD_PORT || 3001}`,
      `NGINX_HTTP_PORT=${config.NGINX_HTTP_PORT || 80}`,
      `NGINX_HTTPS_PORT=${config.NGINX_HTTPS_PORT || 443}`,
      ''
    );

    // Database settings (only if explorer or prod profiles are active)
    if (profiles.includes('explorer') || profiles.includes('prod')) {
      lines.push(
        '# Database Settings',
        `POSTGRES_USER=${config.POSTGRES_USER || 'kaspa'}`,
        `POSTGRES_PASSWORD=${config.POSTGRES_PASSWORD}`,
        `POSTGRES_DB=${config.POSTGRES_DB || 'kaspa_explorer'}`,
        `POSTGRES_PORT=${config.POSTGRES_PORT || 5432}`,
        ''
      );
    }

    // Archive database settings (only if archive profile is active)
    if (profiles.includes('archive')) {
      lines.push(
        '# Archive Database Settings',
        `ARCHIVE_POSTGRES_USER=${config.ARCHIVE_POSTGRES_USER || 'kaspa_archive'}`,
        `ARCHIVE_POSTGRES_PASSWORD=${config.ARCHIVE_POSTGRES_PASSWORD || config.POSTGRES_PASSWORD}`,
        `ARCHIVE_POSTGRES_DB=${config.ARCHIVE_POSTGRES_DB || 'kaspa_archive'}`,
        `ARCHIVE_POSTGRES_PORT=${config.ARCHIVE_POSTGRES_PORT || 5433}`,
        ''
      );
    }

    lines.push(
      '# Monitoring Settings',
      `ENABLE_MONITORING=${config.ENABLE_MONITORING !== false ? 'true' : 'false'}`,
      `LOG_LEVEL=${config.LOG_LEVEL || 'info'}`,
      ''
    );

    // SSL settings (only if enabled)
    if (config.ENABLE_SSL) {
      lines.push(
        '# SSL Settings',
        `ENABLE_SSL=${config.ENABLE_SSL}`,
        `SSL_DOMAIN=${config.SSL_DOMAIN || ''}`,
        `SSL_EMAIL=${config.SSL_EMAIL || ''}`,
        ''
      );
    }

    // Indexer settings (only if explorer profile is active)
    if (profiles.includes('explorer')) {
      lines.push(
        '# Indexer Settings',
        `INDEXER_MODE=${config.INDEXER_MODE || 'full'}`,
        ''
      );
    }

    // Mining settings (only if mining profile is active)
    if (profiles.includes('mining')) {
      lines.push(
        '# Mining Settings',
        `MINING_ADDRESS=${config.MINING_ADDRESS || ''}`,
        `STRATUM_PORT=${config.STRATUM_PORT || 5555}`,
        ''
      );
    }

    return lines.join('\n');
  }

  async saveEnvFile(content, targetPath = '.env') {
    try {
      // Backup existing .env if it exists
      try {
        await fs.access(targetPath);
        const backupPath = `${targetPath}.backup.${Date.now()}`;
        await fs.copyFile(targetPath, backupPath);
        console.log(`Backed up existing .env to ${backupPath}`);
      } catch (error) {
        // File doesn't exist, no backup needed
      }

      await fs.writeFile(targetPath, content, 'utf8');
      return { success: true, path: targetPath };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }

  async loadEnvFile(envPath = '.env') {
    try {
      const content = await fs.readFile(envPath, 'utf8');
      const config = {};
      
      content.split('\n').forEach(line => {
        line = line.trim();
        if (line && !line.startsWith('#')) {
          const [key, ...valueParts] = line.split('=');
          if (key && valueParts.length > 0) {
            let value = valueParts.join('=').trim();
            
            // Remove quotes if present
            if ((value.startsWith('"') && value.endsWith('"')) ||
                (value.startsWith("'") && value.endsWith("'"))) {
              value = value.slice(1, -1);
            }
            
            // Convert boolean strings
            if (value === 'true') value = true;
            if (value === 'false') value = false;
            
            // Convert numeric strings
            if (/^\d+$/.test(value)) value = parseInt(value, 10);
            
            config[key.trim()] = value;
          }
        }
      });
      
      return { success: true, config };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        config: {}
      };
    }
  }

  generateDefaultConfig(profiles) {
    const config = {
      PUBLIC_NODE: false,
      KASPA_P2P_PORT: 16110,
      KASPA_RPC_PORT: 16111,
      DASHBOARD_PORT: 3001,
      NGINX_HTTP_PORT: 80,
      NGINX_HTTPS_PORT: 443,
      ENABLE_MONITORING: true,
      LOG_LEVEL: 'info'
    };

    // Add database passwords if needed
    if (profiles.includes('explorer') || profiles.includes('prod')) {
      config.POSTGRES_USER = 'kaspa';
      config.POSTGRES_PASSWORD = this.generateSecurePassword();
      config.POSTGRES_DB = 'kaspa_explorer';
      config.POSTGRES_PORT = 5432;
    }

    // Add archive database settings if needed
    if (profiles.includes('archive')) {
      config.ARCHIVE_POSTGRES_USER = 'kaspa_archive';
      config.ARCHIVE_POSTGRES_PASSWORD = this.generateSecurePassword();
      config.ARCHIVE_POSTGRES_DB = 'kaspa_archive';
      config.ARCHIVE_POSTGRES_PORT = 5433;
    }

    // Add indexer settings if needed
    if (profiles.includes('explorer')) {
      config.INDEXER_MODE = 'full';
    }

    // Add mining settings if needed
    if (profiles.includes('mining')) {
      config.STRATUM_PORT = 5555;
      config.MINING_ADDRESS = '';
    }

    return config;
  }
}

module.exports = ConfigGenerator;
