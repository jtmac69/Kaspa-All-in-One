const crypto = require('crypto');
const fs = require('fs').promises;
const path = require('path');
const Joi = require('joi');

class ConfigGenerator {
  constructor() {
    this.configSchema = Joi.object({
      // Core settings
      PUBLIC_NODE: Joi.boolean().default(false),
      EXTERNAL_IP: Joi.string().ip().allow('').optional(),
      
      // Network settings
      KASPA_P2P_PORT: Joi.number().integer().min(1024).max(65535).default(16110),
      KASPA_RPC_PORT: Joi.number().integer().min(1024).max(65535).default(16111),
      DASHBOARD_PORT: Joi.number().integer().min(1024).max(65535).default(3001),
      NGINX_HTTP_PORT: Joi.number().integer().min(1).max(65535).default(80),
      NGINX_HTTPS_PORT: Joi.number().integer().min(1).max(65535).default(443),
      
      // Database settings
      POSTGRES_USER: Joi.string().alphanum().min(3).max(30).default('kaspa'),
      POSTGRES_PASSWORD: Joi.string().min(16).optional().allow(''),
      POSTGRES_DB: Joi.string().pattern(/^[a-zA-Z0-9_]+$/).min(3).max(30).default('kaspa_explorer'),
      POSTGRES_PORT: Joi.number().integer().min(1024).max(65535).default(5432),
      
      // Archive database settings
      ARCHIVE_POSTGRES_USER: Joi.string().pattern(/^[a-zA-Z0-9_]+$/).min(3).max(30).default('kaspa_archive'),
      ARCHIVE_POSTGRES_PASSWORD: Joi.string().min(16).optional(),
      ARCHIVE_POSTGRES_DB: Joi.string().pattern(/^[a-zA-Z0-9_]+$/).min(3).max(30).default('kaspa_archive'),
      ARCHIVE_POSTGRES_PORT: Joi.number().integer().min(1024).max(65535).default(5433),
      
      // Monitoring settings
      ENABLE_MONITORING: Joi.boolean().default(true),
      LOG_LEVEL: Joi.string().valid('error', 'warn', 'info', 'debug').default('info'),
      
      // SSL settings
      ENABLE_SSL: Joi.boolean().default(false),
      SSL_DOMAIN: Joi.string().hostname().allow('').optional(),
      SSL_EMAIL: Joi.string().email().allow('').optional(),
      
      // Indexer settings
      INDEXER_MODE: Joi.string().valid('full', 'light', 'archive', 'personal').default('full'),
      
      // Mining settings
      MINING_ADDRESS: Joi.string().allow('').optional(),
      STRATUM_PORT: Joi.number().integer().min(1024).max(65535).default(5555)
    });
  }

  generateSecurePassword(length = 32) {
    return crypto.randomBytes(length).toString('base64').slice(0, length);
  }

  async validateConfig(config) {
    try {
      const validated = await this.configSchema.validateAsync(config, {
        abortEarly: false,
        stripUnknown: true
      });
      return { valid: true, config: validated, errors: [] };
    } catch (error) {
      return {
        valid: false,
        config: null,
        errors: error.details.map(d => ({
          field: d.path.join('.'),
          message: d.message
        }))
      };
    }
  }

  async generateEnvFile(config, profiles) {
    const lines = [
      '# Kaspa All-in-One Configuration',
      '# Generated by Installation Wizard',
      `# Date: ${new Date().toISOString()}`,
      '',
      '# Active Profiles',
      `COMPOSE_PROFILES=${profiles.join(',')}`,
      '',
      '# Core Settings',
      `PUBLIC_NODE=${config.PUBLIC_NODE || 'false'}`,
    ];

    if (config.EXTERNAL_IP) {
      lines.push(`EXTERNAL_IP=${config.EXTERNAL_IP}`);
    }

    lines.push(
      '',
      '# Network Ports',
      `KASPA_P2P_PORT=${config.KASPA_P2P_PORT || 16110}`,
      `KASPA_RPC_PORT=${config.KASPA_RPC_PORT || 16111}`,
      `DASHBOARD_PORT=${config.DASHBOARD_PORT || 3001}`,
      `NGINX_HTTP_PORT=${config.NGINX_HTTP_PORT || 80}`,
      `NGINX_HTTPS_PORT=${config.NGINX_HTTPS_PORT || 443}`,
      ''
    );

    // Database settings (only if indexer-services or kaspa-user-applications profiles are active)
    if (profiles.includes('indexer-services') || profiles.includes('kaspa-user-applications')) {
      lines.push(
        '# Database Settings',
        `POSTGRES_USER=${config.POSTGRES_USER || 'kaspa'}`,
        `POSTGRES_PASSWORD=${config.POSTGRES_PASSWORD}`,
        `POSTGRES_DB=${config.POSTGRES_DB || 'kaspa_explorer'}`,
        `POSTGRES_PORT=${config.POSTGRES_PORT || 5432}`,
        ''
      );
    }

    // Archive database settings (only if archive-node profile is active)
    if (profiles.includes('archive-node')) {
      lines.push(
        '# Archive Database Settings',
        `ARCHIVE_POSTGRES_USER=${config.ARCHIVE_POSTGRES_USER || 'kaspa_archive'}`,
        `ARCHIVE_POSTGRES_PASSWORD=${config.ARCHIVE_POSTGRES_PASSWORD || config.POSTGRES_PASSWORD}`,
        `ARCHIVE_POSTGRES_DB=${config.ARCHIVE_POSTGRES_DB || 'kaspa_archive'}`,
        `ARCHIVE_POSTGRES_PORT=${config.ARCHIVE_POSTGRES_PORT || 5433}`,
        ''
      );
    }

    lines.push(
      '# Monitoring Settings',
      `ENABLE_MONITORING=${config.ENABLE_MONITORING !== false ? 'true' : 'false'}`,
      `LOG_LEVEL=${config.LOG_LEVEL || 'info'}`,
      ''
    );

    // Developer Mode settings
    if (config.DEVELOPER_MODE === true || config.DEVELOPER_MODE === 'true') {
      lines.push(
        '# Developer Mode Settings',
        'DEVELOPER_MODE=true',
        `ENABLE_PORTAINER=${config.ENABLE_PORTAINER || 'true'}`,
        `PORTAINER_PORT=${config.PORTAINER_PORT || 9000}`,
        `ENABLE_PGADMIN=${config.ENABLE_PGADMIN || 'true'}`,
        `PGADMIN_PORT=${config.PGADMIN_PORT || 5050}`,
        `PGADMIN_EMAIL=${config.PGADMIN_EMAIL || 'admin@kaspa.local'}`,
        `PGADMIN_PASSWORD=${config.PGADMIN_PASSWORD}`,
        `ENABLE_LOG_ACCESS=${config.ENABLE_LOG_ACCESS || 'true'}`,
        ''
      );
    }

    // SSL settings (only if enabled)
    if (config.ENABLE_SSL) {
      lines.push(
        '# SSL Settings',
        `ENABLE_SSL=${config.ENABLE_SSL}`,
        `SSL_DOMAIN=${config.SSL_DOMAIN || ''}`,
        `SSL_EMAIL=${config.SSL_EMAIL || ''}`,
        ''
      );
    }

    // Indexer settings (only if indexer-services profile is active)
    if (profiles.includes('indexer-services')) {
      lines.push(
        '# Indexer Settings',
        `INDEXER_MODE=${config.INDEXER_MODE || 'full'}`,
        ''
      );
    }

    // Mining settings (only if mining profile is active)
    if (profiles.includes('mining')) {
      lines.push(
        '# Mining Settings',
        `MINING_ADDRESS=${config.MINING_ADDRESS || ''}`,
        `STRATUM_PORT=${config.STRATUM_PORT || 5555}`,
        ''
      );
    }

    // Indexer URL configuration for user applications
    // If both kaspa-user-applications AND indexer-services are selected, use local indexers
    // Otherwise, use public indexers
    if (profiles.includes('kaspa-user-applications')) {
      const useLocalIndexers = profiles.includes('indexer-services');
      
      lines.push('# Indexer URLs for User Applications');
      
      if (useLocalIndexers) {
        lines.push(
          '# Using local indexers (indexer-services profile is active)',
          'REMOTE_KASIA_INDEXER_URL=http://kasia-indexer:8080/',
          'REMOTE_KSOCIAL_INDEXER_URL=http://k-indexer:8080/',
          '# Local Kaspa node WebSocket for apps',
          'REMOTE_KASPA_NODE_WBORSH_URL=ws://kaspa-node:17110'
        );
      } else {
        lines.push(
          '# Using public indexers (indexer-services profile not active)',
          'REMOTE_KASIA_INDEXER_URL=https://api.kasia.io/',
          'REMOTE_KSOCIAL_INDEXER_URL=https://indexer.kaspatalk.net/',
          '# Public Kaspa node WebSocket',
          'REMOTE_KASPA_NODE_WBORSH_URL=wss://api.kasia.io/ws'
        );
      }
      
      lines.push('');
    }

    return lines.join('\n');
  }

  async saveEnvFile(content, targetPath = '.env') {
    try {
      // Backup existing .env if it exists
      try {
        await fs.access(targetPath);
        const backupPath = `${targetPath}.backup.${Date.now()}`;
        await fs.copyFile(targetPath, backupPath);
        console.log(`Backed up existing .env to ${backupPath}`);
      } catch (error) {
        // File doesn't exist, no backup needed
      }

      await fs.writeFile(targetPath, content, 'utf8');
      return { success: true, path: targetPath };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }

  async loadEnvFile(envPath = '.env') {
    try {
      const content = await fs.readFile(envPath, 'utf8');
      const config = {};
      
      content.split('\n').forEach(line => {
        line = line.trim();
        if (line && !line.startsWith('#')) {
          const [key, ...valueParts] = line.split('=');
          if (key && valueParts.length > 0) {
            let value = valueParts.join('=').trim();
            
            // Remove quotes if present
            if ((value.startsWith('"') && value.endsWith('"')) ||
                (value.startsWith("'") && value.endsWith("'"))) {
              value = value.slice(1, -1);
            }
            
            // Convert boolean strings
            if (value === 'true') value = true;
            if (value === 'false') value = false;
            
            // Convert numeric strings
            if (/^\d+$/.test(value)) value = parseInt(value, 10);
            
            config[key.trim()] = value;
          }
        }
      });
      
      return { success: true, config };
    } catch (error) {
      return {
        success: false,
        error: error.message,
        config: {}
      };
    }
  }

  generateDefaultConfig(profiles) {
    const config = {
      PUBLIC_NODE: false,
      KASPA_P2P_PORT: 16110,
      KASPA_RPC_PORT: 16111,
      DASHBOARD_PORT: 3001,
      NGINX_HTTP_PORT: 80,
      NGINX_HTTPS_PORT: 443,
      ENABLE_MONITORING: true,
      LOG_LEVEL: 'info',
      DEVELOPER_MODE: false
    };

    // Add database passwords if needed
    if (profiles.includes('indexer-services') || profiles.includes('kaspa-user-applications')) {
      config.POSTGRES_USER = 'kaspa';
      config.POSTGRES_PASSWORD = this.generateSecurePassword();
      config.POSTGRES_DB = 'kaspa_explorer';
      config.POSTGRES_PORT = 5432;
    }

    // Add archive database settings if needed
    if (profiles.includes('archive-node')) {
      config.ARCHIVE_POSTGRES_USER = 'kaspa_archive';
      config.ARCHIVE_POSTGRES_PASSWORD = this.generateSecurePassword();
      config.ARCHIVE_POSTGRES_DB = 'kaspa_archive';
      config.ARCHIVE_POSTGRES_PORT = 5433;
    }

    // Add indexer settings if needed
    if (profiles.includes('indexer-services')) {
      config.INDEXER_MODE = 'full';
    }

    // Add mining settings if needed
    if (profiles.includes('mining')) {
      config.STRATUM_PORT = 5555;
      config.MINING_ADDRESS = '';
    }

    return config;
  }

  /**
   * Apply developer mode features to configuration
   * @param {Object} config - Base configuration
   * @param {boolean} developerMode - Whether developer mode is enabled
   * @returns {Object} Configuration with developer mode applied
   */
  applyDeveloperMode(config, developerMode = false) {
    if (!developerMode) {
      return config;
    }

    const devConfig = { ...config };
    
    // Enable debug logging
    devConfig.LOG_LEVEL = 'debug';
    
    // Enable development tools
    devConfig.ENABLE_PORTAINER = 'true';
    devConfig.PORTAINER_PORT = 9000;
    devConfig.ENABLE_PGADMIN = 'true';
    devConfig.PGADMIN_PORT = 5050;
    devConfig.PGADMIN_EMAIL = 'admin@kaspa.local';
    devConfig.PGADMIN_PASSWORD = this.generateSecurePassword(16);
    
    // Enable log access
    devConfig.ENABLE_LOG_ACCESS = 'true';
    
    return devConfig;
  }

  /**
   * Generate docker-compose.override.yml for developer mode
   * @param {Object} config - Configuration with developer mode settings
   * @param {string[]} profiles - Selected profiles
   * @returns {string} docker-compose.override.yml content
   */
  async generateDockerComposeOverride(config, profiles) {
    if (!config.DEVELOPER_MODE && config.DEVELOPER_MODE !== 'true') {
      return null; // No override needed
    }

    const lines = [
      '# Docker Compose Override for Developer Mode',
      '# Generated by Installation Wizard',
      `# Date: ${new Date().toISOString()}`,
      '',
      'version: "3.8"',
      '',
      'services:',
      ''
    ];

    // Add Portainer service
    lines.push(
      '  portainer:',
      '    image: portainer/portainer-ce:latest',
      '    container_name: kaspa-portainer',
      '    restart: unless-stopped',
      '    ports:',
      `      - "${config.PORTAINER_PORT || 9000}:9000"`,
      '    volumes:',
      '      - /var/run/docker.sock:/var/run/docker.sock',
      '      - portainer_data:/data',
      '    networks:',
      '      - kaspa-network',
      ''
    );

    // Add pgAdmin service if database profiles are selected
    if (profiles.includes('indexer-services') || profiles.includes('kaspa-user-applications') || profiles.includes('archive-node')) {
      lines.push(
        '  pgadmin:',
        '    image: dpage/pgadmin4:latest',
        '    container_name: kaspa-pgadmin',
        '    restart: unless-stopped',
        '    environment:',
        `      PGADMIN_DEFAULT_EMAIL: ${config.PGADMIN_EMAIL || 'admin@kaspa.local'}`,
        `      PGADMIN_DEFAULT_PASSWORD: ${config.PGADMIN_PASSWORD}`,
        '      PGADMIN_CONFIG_SERVER_MODE: "False"',
        '      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: "False"',
        '    ports:',
        `      - "${config.PGADMIN_PORT || 5050}:80"`,
        '    volumes:',
        '      - pgadmin_data:/var/lib/pgadmin',
        '    networks:',
        '      - kaspa-network',
        '    depends_on:',
        '      - timescaledb',
        ''
      );
    }

    // Override existing services to enable debug logging
    const servicesToOverride = [];
    
    if (profiles.includes('core')) {
      servicesToOverride.push('kaspa-node', 'dashboard');
    }
    if (profiles.includes('indexer-services')) {
      servicesToOverride.push('k-indexer', 'simply-kaspa-indexer');
    }
    if (profiles.includes('kaspa-user-applications')) {
      servicesToOverride.push('kasia-app', 'kasia-indexer', 'k-social-app');
    }

    for (const service of servicesToOverride) {
      lines.push(
        `  ${service}:`,
        '    environment:',
        '      LOG_LEVEL: debug',
        ''
      );
    }

    // Add volumes
    lines.push(
      'volumes:',
      '  portainer_data:',
      '    driver: local'
    );

    if (profiles.includes('indexer-services') || profiles.includes('kaspa-user-applications') || profiles.includes('archive-node')) {
      lines.push(
        '  pgadmin_data:',
        '    driver: local'
      );
    }

    lines.push('');

    return lines.join('\n');
  }

  /**
   * Save docker-compose.override.yml file
   * @param {string} content - Override file content
   * @param {string} targetPath - Target file path
   * @returns {Promise<Object>} Result object
   */
  async saveDockerComposeOverride(content, targetPath = 'docker-compose.override.yml') {
    if (!content) {
      // Remove override file if it exists
      try {
        await fs.unlink(targetPath);
        console.log('Removed docker-compose.override.yml (Developer Mode disabled)');
      } catch (error) {
        // File doesn't exist, that's fine
      }
      return { success: true, removed: true };
    }

    try {
      // Backup existing override if it exists
      try {
        await fs.access(targetPath);
        const backupPath = `${targetPath}.backup.${Date.now()}`;
        await fs.copyFile(targetPath, backupPath);
        console.log(`Backed up existing override to ${backupPath}`);
      } catch (error) {
        // File doesn't exist, no backup needed
      }

      await fs.writeFile(targetPath, content, 'utf8');
      return { success: true, path: targetPath };
    } catch (error) {
      return {
        success: false,
        error: error.message
      };
    }
  }
}

module.exports = ConfigGenerator;
