<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Integration Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 4px solid #70c7ba;
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #70c7ba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #5fb5a8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .status.info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .status.success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
        }
        .status.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #70c7ba, #5fb5a8);
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .logs {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
        }
        .log-timestamp {
            color: #858585;
        }
        .log-stage {
            color: #4ec9b0;
            font-weight: bold;
        }
        .log-message {
            color: #d4d4d4;
        }
        .connection-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .connection-status.connected {
            background: #4caf50;
            color: white;
        }
        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }
        .connection-status.connecting {
            background: #ff9800;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebSocket Integration Test</h1>
        <p class="subtitle">Test the install module WebSocket connection and events</p>
        
        <!-- Connection Status -->
        <div class="test-section">
            <h2>Connection Status</h2>
            <p>
                WebSocket: <span class="connection-status connecting" id="ws-status">Connecting...</span>
            </p>
            <button onclick="testConnection()">Test Connection</button>
            <button onclick="disconnect()">Disconnect</button>
            <button onclick="reconnect()">Reconnect</button>
            <div id="connection-result"></div>
        </div>
        
        <!-- Installation Test -->
        <div class="test-section">
            <h2>Installation Test</h2>
            <p>Test the complete installation flow with WebSocket events</p>
            <button onclick="startTestInstallation()" id="start-btn">Start Test Installation</button>
            <button onclick="cancelTestInstallation()" id="cancel-btn" disabled>Cancel Installation</button>
            
            <div class="progress-bar">
                <div class="progress-fill" id="test-progress">0%</div>
            </div>
            
            <div id="install-status"></div>
            
            <div class="logs" id="test-logs">
                <div class="log-entry">Waiting for installation to start...</div>
            </div>
        </div>
        
        <!-- Event Monitoring -->
        <div class="test-section">
            <h2>Event Monitoring</h2>
            <p>Monitor WebSocket events in real-time</p>
            <button onclick="clearEvents()">Clear Events</button>
            <div class="logs" id="event-logs">
                <div class="log-entry">No events yet...</div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let socket = null;
        let isInstalling = false;
        
        // Initialize WebSocket connection
        function initWebSocket() {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus('connected');
                logEvent('connect', 'WebSocket connected');
            });
            
            socket.on('disconnect', () => {
                updateConnectionStatus('disconnected');
                logEvent('disconnect', 'WebSocket disconnected');
            });
            
            socket.on('connect_error', (error) => {
                updateConnectionStatus('disconnected');
                logEvent('connect_error', `Connection error: ${error.message}`);
            });
            
            // Installation events
            socket.on('install:progress', (data) => {
                logEvent('install:progress', data);
                updateProgress(data);
            });
            
            socket.on('install:complete', (data) => {
                logEvent('install:complete', data);
                handleComplete(data);
            });
            
            socket.on('install:error', (data) => {
                logEvent('install:error', data);
                handleError(data);
            });
        }
        
        function updateConnectionStatus(status) {
            const statusEl = document.getElementById('ws-status');
            statusEl.className = `connection-status ${status}`;
            statusEl.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        function logEvent(event, data) {
            const logsEl = document.getElementById('event-logs');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-stage">${event}</span>
                <span class="log-message">${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</span>
            `;
            logsEl.appendChild(entry);
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        function addLog(message, stage = 'info') {
            const logsEl = document.getElementById('test-logs');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                ${stage ? `<span class="log-stage">[${stage}]</span>` : ''}
                <span class="log-message">${message}</span>
            `;
            logsEl.appendChild(entry);
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        function updateProgress(data) {
            const { stage, message, progress } = data;
            
            // Update progress bar
            const progressEl = document.getElementById('test-progress');
            progressEl.style.width = `${progress}%`;
            progressEl.textContent = `${Math.round(progress)}%`;
            
            // Update status
            const statusEl = document.getElementById('install-status');
            statusEl.className = 'status info';
            statusEl.innerHTML = `
                <strong>Stage:</strong> ${stage}<br>
                <strong>Progress:</strong> ${progress}%<br>
                <strong>Message:</strong> ${message}
            `;
            
            // Add to logs
            addLog(message, stage);
        }
        
        function handleComplete(data) {
            isInstalling = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('cancel-btn').disabled = true;
            
            const statusEl = document.getElementById('install-status');
            statusEl.className = 'status success';
            statusEl.innerHTML = `
                <strong>✓ Installation Complete!</strong><br>
                ${data.message}
            `;
            
            addLog('Installation completed successfully!', 'complete');
        }
        
        function handleError(data) {
            isInstalling = false;
            document.getElementById('start-btn').disabled = false;
            document.getElementById('cancel-btn').disabled = true;
            
            const statusEl = document.getElementById('install-status');
            statusEl.className = 'status error';
            statusEl.innerHTML = `
                <strong>✗ Installation Failed</strong><br>
                <strong>Stage:</strong> ${data.stage}<br>
                <strong>Message:</strong> ${data.message}<br>
                ${data.error ? `<strong>Error:</strong> ${data.error}` : ''}
            `;
            
            addLog(`ERROR: ${data.message}`, data.stage);
        }
        
        function testConnection() {
            const resultEl = document.getElementById('connection-result');
            if (socket && socket.connected) {
                resultEl.className = 'status success';
                resultEl.textContent = '✓ WebSocket is connected and ready';
            } else {
                resultEl.className = 'status error';
                resultEl.textContent = '✗ WebSocket is not connected';
            }
        }
        
        function disconnect() {
            if (socket) {
                socket.disconnect();
            }
        }
        
        function reconnect() {
            if (socket) {
                socket.connect();
            } else {
                initWebSocket();
            }
        }
        
        function startTestInstallation() {
            if (!socket || !socket.connected) {
                alert('WebSocket is not connected. Please wait or reconnect.');
                return;
            }
            
            isInstalling = true;
            document.getElementById('start-btn').disabled = true;
            document.getElementById('cancel-btn').disabled = false;
            
            // Clear logs
            document.getElementById('test-logs').innerHTML = '';
            
            // Reset progress
            const progressEl = document.getElementById('test-progress');
            progressEl.style.width = '0%';
            progressEl.textContent = '0%';
            
            // Test configuration
            const config = {
                externalIp: '192.168.1.100',
                publicNode: false,
                postgresPassword: 'test-password-123',
                customEnvVars: []
            };
            
            const profiles = ['core'];
            
            addLog('Starting test installation...', 'init');
            addLog(`Config: ${JSON.stringify(config)}`, 'init');
            addLog(`Profiles: ${JSON.stringify(profiles)}`, 'init');
            
            // Emit install:start event
            socket.emit('install:start', {
                config,
                profiles
            });
        }
        
        function cancelTestInstallation() {
            if (confirm('Are you sure you want to cancel the installation?')) {
                socket.emit('install:cancel');
                addLog('Installation cancelled by user', 'cancel');
                isInstalling = false;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('cancel-btn').disabled = true;
            }
        }
        
        function clearEvents() {
            document.getElementById('event-logs').innerHTML = '<div class="log-entry">No events yet...</div>';
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
        });
    </script>
</body>
</html>
