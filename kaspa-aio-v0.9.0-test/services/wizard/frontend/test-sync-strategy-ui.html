<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Strategy UI Test</title>
    <link rel="stylesheet" href="public/styles/wizard.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #70C7BA;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .test-button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #70C7BA 0%, #49C8B5 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 10px 10px 0;
            transition: transform 0.2s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .test-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: white;
            border-left: 4px solid #70C7BA;
        }
        .spinner-small {
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top-color: #70C7BA;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .install-progress {
            margin-top: 20px;
        }
        .install-status {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #install-status-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        #install-status-message {
            color: #7f8c8d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1 style="margin: 0 0 10px 0; color: #2c3e50;">ðŸ§ª Sync Strategy UI Tests</h1>
            <p style="margin: 0; color: #7f8c8d;">
                Test the node synchronization strategy dialog and UI components
            </p>
        </div>

        <!-- Test 1: Show Sync Strategy Dialog -->
        <div class="test-section">
            <h2 style="margin-top: 0; color: #2c3e50;">Test 1: Sync Strategy Dialog</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">
                Click the button to show the sync strategy selection dialog with mock data.
            </p>
            <button class="test-button" onclick="testSyncStrategyDialog()">
                Show Sync Strategy Dialog
            </button>
            <div id="test1-result" class="test-result" style="display: none;">
                <strong>User selected:</strong> <span id="test1-choice"></span>
            </div>
        </div>

        <!-- Test 2: Wait Strategy UI -->
        <div class="test-section">
            <h2 style="margin-top: 0; color: #2c3e50;">Test 2: "Wait" Strategy UI</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">
                Show the sync progress section that appears when user chooses "Wait for sync".
            </p>
            <button class="test-button" onclick="testWaitStrategyUI()">
                Show Wait Strategy UI
            </button>
            <button class="test-button" onclick="simulateSyncProgress()">
                Simulate Progress Updates
            </button>
            <div class="install-progress">
                <div class="install-status">
                    <div id="install-status-title">Installation Progress</div>
                    <div id="install-status-message">Ready to test</div>
                </div>
            </div>
        </div>

        <!-- Test 3: Background Strategy UI -->
        <div class="test-section">
            <h2 style="margin-top: 0; color: #2c3e50;">Test 3: "Background" Strategy UI</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">
                Show the background sync indicator that appears when user chooses "Continue in background".
            </p>
            <button class="test-button" onclick="testBackgroundStrategyUI()">
                Show Background Strategy UI
            </button>
            <button class="test-button" onclick="simulateBackgroundProgress()">
                Simulate Background Updates
            </button>
            <div class="install-progress">
                <div class="install-status">
                    <div id="install-status-title-bg">Installation Progress</div>
                    <div id="install-status-message-bg">Ready to test</div>
                </div>
            </div>
        </div>

        <!-- Test 4: Skip Strategy UI -->
        <div class="test-section">
            <h2 style="margin-top: 0; color: #2c3e50;">Test 4: "Skip" Strategy UI</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">
                Show the UI update when user chooses "Skip and use public network".
            </p>
            <button class="test-button" onclick="testSkipStrategyUI()">
                Show Skip Strategy UI
            </button>
            <div id="test4-result" class="test-result" style="display: none;">
                <div id="test4-message"></div>
            </div>
        </div>

        <!-- Test 5: Sync Complete -->
        <div class="test-section">
            <h2 style="margin-top: 0; color: #2c3e50;">Test 5: Sync Complete Event</h2>
            <p style="color: #7f8c8d; margin-bottom: 15px;">
                Test the UI update when sync completes.
            </p>
            <button class="test-button" onclick="testSyncComplete()">
                Trigger Sync Complete
            </button>
            <div id="test5-result" class="test-result" style="display: none;">
                <div id="test5-message"></div>
            </div>
        </div>
    </div>

    <!-- Import modules -->
    <script type="module">
        import { 
            showSyncStrategyDialog,
            updateUIForSyncStrategy,
            updateSyncProgress,
            handleSyncComplete
        } from './public/scripts/modules/install.js';

        // Make functions available globally for onclick handlers
        window.showSyncStrategyDialog = showSyncStrategyDialog;
        window.updateSyncProgress = updateSyncProgress;
        window.handleSyncComplete = handleSyncComplete;

        // Test 1: Show sync strategy dialog
        window.testSyncStrategyDialog = async function() {
            const mockSyncData = {
                syncStatus: {
                    connected: true,
                    synced: false,
                    currentBlock: 5000000,
                    targetBlock: 10000000,
                    blocksRemaining: 5000000,
                    percentage: 50.0,
                    estimatedTimeRemaining: 3600,
                    syncRate: 1388.89
                },
                estimatedTime: '1 hour',
                nodeKey: 'localhost:16110',
                options: [
                    {
                        id: 'wait',
                        label: 'Wait for sync to complete',
                        description: 'Wizard will show progress and wait for full synchronization',
                        recommended: false,
                        estimatedTime: 3600
                    },
                    {
                        id: 'background',
                        label: 'Continue in background',
                        description: 'Node syncs while wizard proceeds. Services needing synced node will wait.',
                        recommended: true,
                        estimatedTime: 0
                    },
                    {
                        id: 'skip',
                        label: 'Skip and use public network',
                        description: 'Other services will use public Kaspa nodes instead',
                        recommended: false,
                        estimatedTime: 0
                    }
                ]
            };

            const choice = await showSyncStrategyDialog(mockSyncData);
            
            const resultDiv = document.getElementById('test1-result');
            const choiceSpan = document.getElementById('test1-choice');
            
            if (choice) {
                choiceSpan.textContent = choice;
                choiceSpan.style.color = '#70C7BA';
                choiceSpan.style.fontWeight = '600';
                resultDiv.style.display = 'block';
            } else {
                choiceSpan.textContent = 'Cancelled';
                choiceSpan.style.color = '#e74c3c';
                resultDiv.style.display = 'block';
            }
        };

        // Test 2: Wait strategy UI
        window.testWaitStrategyUI = function() {
            const mockSyncData = {
                syncStatus: {
                    connected: true,
                    synced: false,
                    currentBlock: 5000000,
                    targetBlock: 10000000,
                    blocksRemaining: 5000000,
                    percentage: 50.0,
                    estimatedTimeRemaining: 3600
                },
                estimatedTime: '1 hour'
            };

            // Import and call the function
            import('./public/scripts/modules/install.js').then(module => {
                // Create a mock state manager
                window.stateManager = {
                    get: () => null,
                    set: () => {},
                    update: () => {}
                };

                // Manually create the sync progress section
                const installProgress = document.querySelector('.install-progress');
                const statusDiv = installProgress.querySelector('.install-status');
                
                let syncSection = document.getElementById('sync-progress-section');
                if (!syncSection) {
                    syncSection = document.createElement('div');
                    syncSection.id = 'sync-progress-section';
                    syncSection.className = 'sync-progress-section';
                    syncSection.style.cssText = `
                        background: #f8f9fa;
                        border-radius: 8px;
                        padding: 20px;
                        margin: 20px 0;
                        border-left: 4px solid #70C7BA;
                    `;
                    statusDiv.after(syncSection);
                }

                syncSection.innerHTML = `
                    <h3 style="margin: 0 0 16px 0; color: #2c3e50; font-size: 16px;">
                        ðŸ”„ Node Synchronization Progress
                    </h3>
                    <div id="sync-progress-details">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px;">
                            <span style="color: #7f8c8d;">Progress</span>
                            <span id="sync-percentage" style="color: #2c3e50; font-weight: 600;">
                                ${mockSyncData.syncStatus.percentage.toFixed(1)}%
                            </span>
                        </div>
                        <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                            <div id="sync-progress-bar" style="
                                background: linear-gradient(135deg, #70C7BA 0%, #49C8B5 100%);
                                height: 100%;
                                width: ${mockSyncData.syncStatus.percentage}%;
                                transition: width 0.5s ease;
                            "></div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
                            <div>
                                <div style="color: #7f8c8d; margin-bottom: 4px;">Current Block</div>
                                <div id="sync-current-block" style="color: #2c3e50; font-weight: 600;">
                                    ${mockSyncData.syncStatus.currentBlock.toLocaleString()}
                                </div>
                            </div>
                            <div>
                                <div style="color: #7f8c8d; margin-bottom: 4px;">Target Block</div>
                                <div id="sync-target-block" style="color: #2c3e50; font-weight: 600;">
                                    ${mockSyncData.syncStatus.targetBlock.toLocaleString()}
                                </div>
                            </div>
                            <div>
                                <div style="color: #7f8c8d; margin-bottom: 4px;">Blocks Remaining</div>
                                <div id="sync-blocks-remaining" style="color: #2c3e50; font-weight: 600;">
                                    ${mockSyncData.syncStatus.blocksRemaining.toLocaleString()}
                                </div>
                            </div>
                            <div>
                                <div style="color: #7f8c8d; margin-bottom: 4px;">Time Remaining</div>
                                <div id="sync-time-remaining" style="color: #2c3e50; font-weight: 600;">
                                    ${mockSyncData.estimatedTime}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                syncSection.style.display = 'block';

                // Update status message
                const statusMessage = document.getElementById('install-status-message');
                if (statusMessage) {
                    statusMessage.innerHTML = `
                        <strong>Waiting for node synchronization...</strong><br>
                        <small>This may take some time. You can see progress below.</small>
                    `;
                }
            });
        };

        // Test 2b: Simulate sync progress
        window.simulateSyncProgress = function() {
            let progress = 50;
            const interval = setInterval(() => {
                progress += 5;
                if (progress > 100) {
                    progress = 100;
                    clearInterval(interval);
                }

                const mockStatus = {
                    connected: true,
                    synced: progress >= 100,
                    currentBlock: Math.floor(5000000 + (progress - 50) * 100000),
                    targetBlock: 10000000,
                    blocksRemaining: Math.floor((100 - progress) * 100000),
                    percentage: progress,
                    estimatedTimeRemaining: Math.floor((100 - progress) * 36)
                };

                updateSyncProgress(mockStatus);
            }, 1000);
        };

        // Test 3: Background strategy UI
        window.testBackgroundStrategyUI = function() {
            const mockSyncData = {
                syncStatus: {
                    percentage: 50.0,
                    estimatedTimeRemaining: 3600
                },
                estimatedTime: '1 hour'
            };

            const installProgress = document.querySelectorAll('.install-progress')[1];
            const statusDiv = installProgress.querySelector('.install-status');

            let indicator = document.getElementById('background-sync-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'background-sync-indicator';
                indicator.className = 'background-sync-indicator';
                indicator.style.cssText = `
                    background: linear-gradient(135deg, rgba(112, 199, 186, 0.1) 0%, rgba(73, 200, 181, 0.1) 100%);
                    border: 1px solid #70C7BA;
                    border-radius: 8px;
                    padding: 12px 16px;
                    margin: 16px 0;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 13px;
                `;
                statusDiv.after(indicator);
            }

            indicator.innerHTML = `
                <div style="
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    background: white;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                ">
                    <div class="spinner-small"></div>
                </div>
                <div style="flex: 1;">
                    <div style="color: #2c3e50; font-weight: 600; margin-bottom: 2px;">
                        Node syncing in background
                    </div>
                    <div style="color: #7f8c8d; font-size: 12px;">
                        <span id="background-sync-percentage">${mockSyncData.syncStatus.percentage.toFixed(1)}%</span> complete â€¢
                        <span id="background-sync-time">${mockSyncData.estimatedTime}</span> remaining
                    </div>
                </div>
                <button style="
                    padding: 6px 12px;
                    border: 1px solid #70C7BA;
                    background: white;
                    color: #70C7BA;
                    border-radius: 6px;
                    font-size: 12px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                " onmouseover="this.style.background='#70C7BA'; this.style.color='white';"
                   onmouseout="this.style.background='white'; this.style.color='#70C7BA';">
                    Details
                </button>
            `;

            indicator.style.display = 'flex';

            // Update status message
            const statusMessage = document.getElementById('install-status-message-bg');
            if (statusMessage) {
                statusMessage.innerHTML = `
                    <strong>Node syncing in background</strong><br>
                    <small>Installation will continue. Services will use public network until sync completes.</small>
                `;
            }
        };

        // Test 3b: Simulate background progress
        window.simulateBackgroundProgress = function() {
            let progress = 50;
            const interval = setInterval(() => {
                progress += 5;
                if (progress > 100) {
                    progress = 100;
                    clearInterval(interval);
                }

                const mockStatus = {
                    percentage: progress,
                    estimatedTimeRemaining: Math.floor((100 - progress) * 36)
                };

                const percentageEl = document.getElementById('background-sync-percentage');
                if (percentageEl) {
                    percentageEl.textContent = `${mockStatus.percentage.toFixed(1)}%`;
                }

                const timeEl = document.getElementById('background-sync-time');
                if (timeEl && mockStatus.estimatedTimeRemaining > 0) {
                    const minutes = Math.floor(mockStatus.estimatedTimeRemaining / 60);
                    timeEl.textContent = `${minutes} minute${minutes !== 1 ? 's' : ''}`;
                }
            }, 1000);
        };

        // Test 4: Skip strategy UI
        window.testSkipStrategyUI = function() {
            const resultDiv = document.getElementById('test4-result');
            const messageDiv = document.getElementById('test4-message');

            messageDiv.innerHTML = `
                <div style="color: #2c3e50; font-weight: 600; margin-bottom: 8px;">
                    âœ“ Using public Kaspa network
                </div>
                <div style="color: #7f8c8d; font-size: 14px;">
                    Services will connect to public nodes. Local node sync has been skipped.
                </div>
            `;

            resultDiv.style.display = 'block';
        };

        // Test 5: Sync complete
        window.testSyncComplete = function() {
            const mockData = {
                nodeKey: 'localhost:16110',
                syncStatus: {
                    synced: true,
                    percentage: 100
                }
            };

            handleSyncComplete(mockData);

            const resultDiv = document.getElementById('test5-result');
            const messageDiv = document.getElementById('test5-message');

            messageDiv.innerHTML = `
                <div style="color: #27ae60; font-weight: 600; margin-bottom: 8px;">
                    âœ“ Node synchronization complete!
                </div>
                <div style="color: #7f8c8d; font-size: 14px;">
                    Services are now using the local node.
                </div>
            `;

            resultDiv.style.display = 'block';
        };
    </script>
</body>
</html>
