<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rollback System - Frontend Example</title>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
    }
    
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-primary { background: #49D49D; color: white; }
    .btn-secondary { background: #70C7BA; color: white; }
    .btn-danger { background: #e74c3c; color: white; }
    
    .history-item {
      padding: 10px;
      margin: 5px 0;
      background: #f5f5f5;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .checkpoint-item {
      padding: 10px;
      margin: 5px 0;
      background: #e8f5f1;
      border-radius: 4px;
    }
    
    #status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    
    .success { background: #d4edda; color: #155724; display: block; }
    .error { background: #f8d7da; color: #721c24; display: block; }
  </style>
</head>
<body>
  <h1>ðŸ”„ Rollback and Recovery System</h1>
  
  <div id="status"></div>
  
  <!-- Undo Button -->
  <div class="section">
    <h2>Quick Actions</h2>
    <button class="btn-primary" onclick="undoLastChange()">â†¶ Undo Last Change</button>
    <button class="btn-secondary" onclick="saveCurrentVersion()">ðŸ’¾ Save Current Version</button>
    <button class="btn-danger" onclick="confirmStartOver()">ðŸ”„ Start Over</button>
  </div>
  
  <!-- Version History -->
  <div class="section">
    <h2>Configuration History</h2>
    <button class="btn-secondary" onclick="loadHistory()">Refresh History</button>
    <div id="history-list"></div>
  </div>
  
  <!-- Checkpoints -->
  <div class="section">
    <h2>Installation Checkpoints</h2>
    <button class="btn-secondary" onclick="loadCheckpoints()">Refresh Checkpoints</button>
    <button class="btn-primary" onclick="createTestCheckpoint()">Create Test Checkpoint</button>
    <div id="checkpoint-list"></div>
  </div>
  
  <!-- Storage Info -->
  <div class="section">
    <h2>Storage Usage</h2>
    <button class="btn-secondary" onclick="loadStorageInfo()">Check Storage</button>
    <div id="storage-info"></div>
  </div>

  <script>
    const API_BASE = '/api/rollback';
    
    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = isError ? 'error' : 'success';
      setTimeout(() => status.style.display = 'none', 5000);
    }
    
    async function undoLastChange() {
      if (!confirm('Undo last configuration change?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/undo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ restartServices: false })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('âœ“ Configuration restored successfully');
          loadHistory();
        } else {
          showStatus('âœ— Failed to undo: ' + result.error, true);
        }
      } catch (error) {
        showStatus('âœ— Network error: ' + error.message, true);
      }
    }
    
    async function saveCurrentVersion() {
      const description = prompt('Enter description for this version:');
      if (!description) return;
      
      try {
        const response = await fetch(`${API_BASE}/save-version`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            config: { EXAMPLE_KEY: 'example-value' },
            profiles: ['core'],
            metadata: {
              action: 'manual-save',
              description: description
            }
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('âœ“ Version saved: ' + result.versionId);
          loadHistory();
        } else {
          showStatus('âœ— Failed to save: ' + result.error, true);
        }
      } catch (error) {
        showStatus('âœ— Network error: ' + error.message, true);
      }
    }
    
    async function loadHistory() {
      try {
        const response = await fetch(`${API_BASE}/history?limit=10`);
        const result = await response.json();
        
        const list = document.getElementById('history-list');
        
        if (result.success && result.entries.length > 0) {
          list.innerHTML = result.entries.map(entry => `
            <div class="history-item">
              <div>
                <strong>${entry.versionId}</strong><br>
                <small>${entry.age} - ${entry.metadata.action}</small><br>
                <small>Profiles: ${entry.profiles.join(', ')}</small>
              </div>
              <button class="btn-primary" onclick="restoreVersion('${entry.versionId}')">
                Restore
              </button>
            </div>
          `).join('');
        } else {
          list.innerHTML = '<p>No version history available</p>';
        }
      } catch (error) {
        showStatus('âœ— Failed to load history: ' + error.message, true);
      }
    }
    
    async function restoreVersion(versionId) {
      if (!confirm('Restore this version?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/restore`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ versionId, restartServices: false })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('âœ“ Version restored: ' + versionId);
          loadHistory();
        } else {
          showStatus('âœ— Failed to restore: ' + result.error, true);
        }
      } catch (error) {
        showStatus('âœ— Network error: ' + error.message, true);
      }
    }
    
    async function createTestCheckpoint() {
      try {
        const response = await fetch(`${API_BASE}/checkpoint`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            stage: 'test-checkpoint',
            data: {
              progress: 50,
              timestamp: new Date().toISOString()
            }
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('âœ“ Checkpoint created: ' + result.checkpointId);
          loadCheckpoints();
        } else {
          showStatus('âœ— Failed to create checkpoint: ' + result.error, true);
        }
      } catch (error) {
        showStatus('âœ— Network error: ' + error.message, true);
      }
    }
    
    async function loadCheckpoints() {
      try {
        const response = await fetch(`${API_BASE}/checkpoints`);
        const result = await response.json();
        
        const list = document.getElementById('checkpoint-list');
        
        if (result.success && result.checkpoints.length > 0) {
          list.innerHTML = result.checkpoints.map(cp => `
            <div class="checkpoint-item">
              <strong>${cp.checkpointId}</strong><br>
              <small>Stage: ${cp.stage} - ${cp.age}</small><br>
              <button class="btn-primary" onclick="restoreCheckpoint('${cp.checkpointId}')">
                Restore
              </button>
              <button class="btn-danger" onclick="deleteCheckpoint('${cp.checkpointId}')">
                Delete
              </button>
            </div>
          `).join('');
        } else {
          list.innerHTML = '<p>No checkpoints available</p>';
        }
      } catch (error) {
        showStatus('âœ— Failed to load checkpoints: ' + error.message, true);
      }
    }
    
    async function restoreCheckpoint(checkpointId) {
      if (!confirm('Restore from this checkpoint?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/restore-checkpoint`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ checkpointId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('âœ“ Checkpoint restored: ' + checkpointId);
        } else {
          showStatus('âœ— Failed to restore: ' + result.error, true);
        }
      } catch (error) {
        showStatus('âœ— Network error: ' + error.message, true);
      }
    }
    
    async function deleteCheckpoint(checkpointId) {
      if (!confirm('Delete this checkpoint?')) return;
      
      try {
        const response = await fetch(`${API_BASE}/checkpoint/${checkpointId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('âœ“ Checkpoint deleted');
          loadCheckpoints();
        } else {
          showStatus('âœ— Failed to delete: ' + result.error, true);
        }
      } catch (error) {
        showStatus('âœ— Network error: ' + error.message, true);
      }
    }
    
    async function loadStorageInfo() {
      try {
        const response = await fetch(`${API_BASE}/storage`);
        const result = await response.json();
        
        const info = document.getElementById('storage-info');
        
        if (result.success) {
          info.innerHTML = `
            <p><strong>Total Size:</strong> ${result.totalSizeMB} MB</p>
            <p><strong>File Count:</strong> ${result.fileCount}</p>
            <p><strong>Location:</strong> ${result.backupDir}</p>
          `;
        } else {
          info.innerHTML = '<p>Failed to load storage info</p>';
        }
      } catch (error) {
        showStatus('âœ— Failed to load storage info: ' + error.message, true);
      }
    }
    
    async function confirmStartOver() {
      const confirmed = confirm(
        'This will remove all containers, volumes, and configurations. ' +
        'Are you sure you want to start over?'
      );
      
      if (!confirmed) return;
      
      try {
        const response = await fetch(`${API_BASE}/start-over`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            deleteData: true,
            deleteConfig: true,
            deleteBackups: false
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showStatus('âœ“ System reset successfully');
          setTimeout(() => location.reload(), 2000);
        } else {
          showStatus('âœ— Failed to reset: ' + result.error, true);
        }
      } catch (error) {
        showStatus('âœ— Network error: ' + error.message, true);
      }
    }
    
    // Load initial data
    loadHistory();
    loadCheckpoints();
  </script>
</body>
</html>
